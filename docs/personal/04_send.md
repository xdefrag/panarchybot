# Отправка средств

## Триггеры
- Команда `/send`
- Кнопки в интерфейсе баланса
- Ответ на сообщение пользователя (для указания получателя)

## Технический процесс

### 1. Инициализация отправки
- Проверка аккаунта отправителя
- Получение списка доступных активов
- Создание интерактивного меню выбора актива
- Сохранение состояния операции

### 2. Выбор актива
- Обработка callback query выбора актива
- Проверка баланса для выбранного актива
- Запрос суммы перевода
- Валидация доступного баланса с учетом резерва

### 3. Определение получателя
- Поддержка различных форматов ввода:
  - Telegram username
  - Stellar адрес
  - Ответ на сообщение пользователя
- Валидация существования получателя
- Проверка trustline получателя для выбранного актива

### 4. Подготовка транзакции
- Создание транзакции Payment
- Установка параметров:
  - Отправитель (source account)
  - Получатель (destination)
  - Актив и сумма
  - Memo (опционально)
- Расчет комиссии сети
- Проверка достаточности средств с учетом комиссии

### 5. Подтверждение
- Отображение деталей перевода:
  - Получатель
  - Сумма и актив
  - Комиссия
  - Memo (если есть)
- Запрос подтверждения через кнопки
- Таймаут на подтверждение

### 6. Выполнение
- Подписание транзакции
- Отправка в сеть
- Мониторинг статуса
- Обработка результата

### 7. Завершение
- Проверка успешности
- Обновление балансов
- Уведомление отправителя
- Уведомление получателя (если это пользователь бота)
- Сохранение в истории операций

## Обработка ошибок
- Недостаточный баланс
- Отсутствие trustline у получателя
- Неверный формат адреса
- Превышение лимитов
- Ошибки сети
- Отмена пользователем

## Безопасность
- Проверка лимитов на операции
- Подтверждение крупных переводов
- Защита от спама
- Валидация адресов
- Проверка истории операций
- Мониторинг подозрительной активности

## Оптимизация
- Кэширование частых получателей
- Быстрые переводы для доверенных пользователей
- Batch-обработка транзакций
- Асинхронные уведомления
- Приоритизация транзакций 