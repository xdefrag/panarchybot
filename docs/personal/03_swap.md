# Обмен активов (Swap)

## Триггеры
- Команда `/swap`
- Интерактивные кнопки в меню баланса

## Технический процесс

### 1. Инициализация обмена
- Проверка доступности аккаунта пользователя
- Получение списка доступных активов (trustlines)
- Создание интерактивной клавиатуры с активами
- Сохранение состояния обмена в памяти/базе данных

### 2. Выбор исходного актива
- Обработка callback query от кнопок
- Валидация выбранного актива
- Проверка баланса для обмена
- Сохранение выбора в состоянии
- Отображение списка целевых активов

### 3. Выбор целевого актива
- Обработка callback query для целевого актива
- Исключение исходного актива из списка
- Проверка существования пары активов
- Получение текущего курса обмена
- Запрос количества для обмена

### 4. Расчет обмена
- Получение актуального пути обмена через Stellar DEX
- Расчет:
  - Курса обмена
  - Комиссий сети
  - Проскальзывания
  - Минимального получаемого количества
- Проверка достаточности ликвидности

### 5. Подтверждение обмена
- Отображение деталей операции:
  - Исходная сумма и актив
  - Получаемая сумма и актив
  - Курс обмена
  - Комиссии
- Запрос подтверждения через кнопки

### 6. Выполнение обмена
- Создание транзакции PathPayment
- Установка параметров:
  - Максимальная входящая сумма
  - Минимальная исходящая сумма
  - Путь обмена
  - Таймаут операции
- Подписание транзакции
- Отправка в сеть
- Мониторинг выполнения

### 7. Завершение операции
- Проверка успешности транзакции
- Обновление балансов
- Отправка подтверждения пользователю
- Очистка состояния обмена
- Сохранение истории операции

## Обработка ошибок
- Недостаточный баланс
- Отсутствие ликвидности
- Превышение проскальзывания
- Таймаут операции
- Отмена пользователем
- Ошибки сети Stellar

## Оптимизация
- Предварительный расчет путей обмена
- Кэширование курсов
- Мониторинг ликвидности
- Автоматический выбор оптимального пути
- Агрегация нескольких DEX для лучших курсов

## Безопасность
- Проверка лимитов на операции
- Защита от фронтраннинга
- Валидация курсов обмена
- Проверка доверенных эмитентов
- Мониторинг подозрительных операций 